<html>
<head>
</head>
<body style="background: transparent;">
    <script src="scripts/docstrap.lib.js"></script>
    <script src="scripts/lunr.min.js"></script>
    <script src="scripts/fulltext-search.js"></script>

    <script type="text/x-docstrap-searchdb">
    {"modules_config.js.html":{"id":"modules_config.js.html","title":"Source: modules/config.js","body":" БОТ Возрастной рейтинг Classes testVK Global configportrawBody Source: modules/config.js const fs = require(&quot;fs&quot;); /** * Возвращает конфигурацию для ВК callback API * @returns {{confirmation_token: string, messsage_token: string, secret: string}} */ const config = function(){ try{ if(fs.existsSync(&quot;./modules/config.json&quot;)){ return JSON.parse(fs.readFileSync(&quot;./modules/config.json&quot;)); }else if(fs.existsSync(&quot;./modules/default_config.json&quot;)){ return JSON.parse(fs.readFileSync(&quot;./modules/default_config.json&quot;)); }else{ return { &quot;confirmation_token&quot;: &quot;&quot;, &quot;message_token&quot;: &quot;&quot;, &quot;secret&quot;: &quot;&quot; }; } }catch(e){ return { &quot;confirmation_token&quot;: &quot;&quot;, &quot;message_token&quot;: &quot;&quot;, &quot;secret&quot;: &quot;&quot; }; } }; module.exports = config; × Search results Close Бот для ВК, определяющий возрастной рейтинг материала "},"index.js.html":{"id":"index.js.html","title":"Source: index.js","body":" БОТ Возрастной рейтинг Classes testVK Global configportrawBody Source: index.js const express = require('express'); const fs = require('fs'); const VK = new (require(&quot;./modules/VK&quot;))(); let app = express(); /** * Порт веб-сервера. * @type {number} */ const port = process.env.PORT || 80; /** * Получает тело запроса без обработки * @param req * @param res * @param next */ function rawBody(req, res, next) { req.setEncoding('utf8'); req.rawBody = ''; req.on('data', function(chunk) { req.rawBody += chunk; }); req.on('end', function(){ next(); }); } app.use(rawBody); app.post('/bot_age', (req, res) =&gt; { let data = null; try{ data = JSON.parse(req.rawBody); }catch(e){ console.log(e); } if(data === null){ res.send(&quot;ok&quot;); }else{ VK.answerTest(data) .then(r =&gt; { res.send(r); }) .catch(err =&gt; { console.error(err); res.send(&quot;ok&quot;); }); } }); app.listen(port, function () { console.log('Listening on port ', port); }); × Search results Close Бот для ВК, определяющий возрастной рейтинг материала "},"modules_test.js.html":{"id":"modules_test.js.html","title":"Source: modules/test.js","body":" БОТ Возрастной рейтинг Classes testVK Global configportrawBody Source: modules/test.js const fs = require('fs'); /** * Содержит функции для теста * @class */ const test = function(){ /** * Переменная содержит список текущих пользователей * @private * @type {string[]} */ let users = {}; /** * Переменная содержит этапы теста * @private * @type {string[]} */ let stages = []; /** * Возвращает ответ на тест в случае положительного ответа * @param {number} user ID пользователя ВК * @returns {string} */ function yes(user){ let stage = stages[users[user]].name; delete users[user]; return &quot;Рейтинг вашего материала: &quot; + stage; } /** * Возвращает ответ на тест в случае отрицательного ответа * @param {number} user ID пользователя ВК * @returns {string} */ function no(user){ users[user]++; if(users[user] === stages.length - 1){ delete users[user]; return &quot;Рейтинг вашего материала: &quot; + stages[stages.length - 1].name; }else{ return stages[users[user]].text; } } /** * Возвращает ответ в зависимости от текста сообщения и ID пользователя * @param {number} user ID пользователя ВК * @param {string} message Сообщение пользователя * @returns {Promise} Промис, который возвращает ответ на сообщение в resolve */ this.findAnswer = function(user, message){ return new Promise((resolve, reject) =&gt; { if(users[user] || users[user] === 0){ if(message === &quot;да&quot;){ resolve(yes(user)); } else if(message === &quot;нет&quot;){ resolve(no(user)); } else { resolve(`Отвечайте &quot;да&quot; или &quot;нет&quot; (без кавычек)`); } }else{ users[user] = 0; resolve(stages[users[user]].text) } }); }; /** * Загружает список этапов теста */ function loadStages(){ try{ stages = JSON.parse(fs.readFileSync(&quot;./stages.json&quot;, &quot;utf8&quot;)); }catch(e){ console.error(&quot;Ошибка: не получается загрузить этапы теста!&quot;); console.error(e); } } loadStages(); }; module.exports = test; × Search results Close Бот для ВК, определяющий возрастной рейтинг материала "},"modules_VK.js.html":{"id":"modules_VK.js.html","title":"Source: modules/VK.js","body":" БОТ Возрастной рейтинг Classes testVK Global configportrawBody Source: modules/VK.js const config = require(&quot;./config&quot;)(); const Test = new (require(&quot;./test&quot;))(); const request = require('request'); const extend = require('extend'); /** * Содержит функции для работы с ВК * @class */ const VK = function(){ /** * Очередь сообщений для отправки * @private * @type {string[]} */ let messages = []; /** * Добавляет сообщение в очередь на отправку * @param {string} message */ function sendMessage(message){ let answer = { access_token: config.message_token, v: '5.0' }; extend(answer, message); messages.push(answer); } /** * Отправляет первые 20 сообщений из очереди */ function messageHandler(){ let arr = messages.splice(0, 20); if(arr.length){ let now = Date.now(); arr.forEach(v =&gt; { if((v.delay &amp;&amp; v.delay &lt;= now) || !v.delay){ delete v.delay; request.post({ url: 'https://api.vk.com/method/messages.send', form: v }, function(error, response, body){ if(error){ messages.push(v); } }); }else{ messages.push(v); } }); } } /** * Запускает проверку очереди каждую секунду * @private */ function _init(){ setInterval(() =&gt; { messageHandler(); }, 1001); } /** * Отвечает на сообщение пользователя * @param {string} data Объект, полученный через Callback API * @returns {Promise} Промисы возвращает ok, если сообщение удалось обработать, либо ошибку */ this.answerTest = function(data){ return new Promise((resolve, reject) =&gt; { if(data.secret &amp;&amp; data.secret === config.secret){ if(data.type === &quot;confirmation&quot;){ resolve(config.confirmation_token); } else if(data.type === &quot;message_new&quot;){ Test.findAnswer(data.object.user_id, data.object.body.toLowerCase()) .then(a =&gt; { sendMessage({ user_id: data.object.user_id, message: a }); }) .catch(err =&gt; console.error(err)); resolve(&quot;ok&quot;); } else{ reject(&quot;Wrong type&quot;); } }else{ reject(&quot;Wrong secret&quot;); } }); }; _init(); }; module.exports = VK; × Search results Close Бот для ВК, определяющий возрастной рейтинг материала "},"global.html":{"id":"global.html","title":"Global","body":" БОТ Возрастной рейтинг Classes testVK Global configportrawBody Global Members &lt;constant&gt; port :number Порт веб-сервера. Type: number Source: index.js, line 11 Methods config() Возвращает конфигурацию для ВК callback API Source: modules/config.js, line 7 Returns: Type Object rawBody(req, res, next) Получает тело запроса без обработки Parameters: Name Type Description req res next Source: index.js, line 19 × Search results Close Бот для ВК, определяющий возрастной рейтинг материала "},"classes.list.html":{"id":"classes.list.html","title":"Classes","body":" БОТ Возрастной рейтинг Classes testVK Global configportrawBody Classes Classes test VK × Search results Close Бот для ВК, определяющий возрастной рейтинг материала "},"index.html":{"id":"index.html","title":"Index","body":" БОТ Возрастной рейтинг Classes testVK Global configportrawBody × Search results Close Бот для ВК, определяющий возрастной рейтинг материала "},"test.html":{"id":"test.html","title":"Class: test","body":" БОТ Возрастной рейтинг Classes testVK Global configportrawBody Class: test test new test() Содержит функции для теста Source: modules/test.js, line 8 Members &lt;private, inner&gt; stages :Array.&lt;string&gt; Переменная содержит этапы теста Type: Array.&lt;string&gt; Source: modules/test.js, line 21 &lt;private, inner&gt; users :Array.&lt;string&gt; Переменная содержит список текущих пользователей Type: Array.&lt;string&gt; Source: modules/test.js, line 14 Methods findAnswer(user, message) Возвращает ответ в зависимости от текста сообщения и ID пользователя Parameters: Name Type Description user number ID пользователя ВК message string Сообщение пользователя Source: modules/test.js, line 57 Returns: Промис, который возвращает ответ на сообщение в resolve Type Promise &lt;inner&gt; loadStages() Загружает список этапов теста Source: modules/test.js, line 94 &lt;inner&gt; no(user) Возвращает ответ на тест в случае отрицательного ответа Parameters: Name Type Description user number ID пользователя ВК Source: modules/test.js, line 40 Returns: Type string &lt;inner&gt; yes(user) Возвращает ответ на тест в случае положительного ответа Parameters: Name Type Description user number ID пользователя ВК Source: modules/test.js, line 28 Returns: Type string × Search results Close Бот для ВК, определяющий возрастной рейтинг материала "},"VK.html":{"id":"VK.html","title":"Class: VK","body":" БОТ Возрастной рейтинг Classes testVK Global configportrawBody Class: VK VK new VK() Содержит функции для работы с ВК Source: modules/VK.js, line 11 Members &lt;private, inner&gt; messages :Array.&lt;string&gt; Очередь сообщений для отправки Type: Array.&lt;string&gt; Source: modules/VK.js, line 18 Methods answerTest(data) Отвечает на сообщение пользователя Parameters: Name Type Description data string Объект, полученный через Callback API Source: modules/VK.js, line 75 Returns: Промисы возвращает ok, если сообщение удалось обработать, либо ошибку Type Promise &lt;private, inner&gt; _init() Запускает проверку очереди каждую секунду Source: modules/VK.js, line 64 &lt;inner&gt; messageHandler() Отправляет первые 20 сообщений из очереди Source: modules/VK.js, line 37 &lt;inner&gt; sendMessage(message) Добавляет сообщение в очередь на отправку Parameters: Name Type Description message string Source: modules/VK.js, line 24 × Search results Close Бот для ВК, определяющий возрастной рейтинг материала "}}
    </script>

    <script type="text/javascript">
        $(document).ready(function() {
            Searcher.init();
        });

        $(window).on("message", function(msg) {
            var msgData = msg.originalEvent.data;

            if (msgData.msgid != "docstrap.quicksearch.start") {
                return;
            }

            var results = Searcher.search(msgData.searchTerms);

            window.parent.postMessage({"results": results, "msgid": "docstrap.quicksearch.done"}, "*");
        });
    </script>
</body>
</html>
